<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Control Panel</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Custom styles for appearance */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .circle-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 max-w-sm w-full space-y-6 text-center">
        <h1 class="text-2xl font-bold">Security System Control</h1>

        <div id="status-container" class="bg-black text-white p-4 rounded-xl font-medium transition-colors duration-500">
            <span id="status-label">Loading status...</span>
        </div>

        <div class="flex flex-row space-x-4 justify-center">
            <button id="start-btn" class="circle-button transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-wait
                                         bg-green-500 hover:bg-green-600 text-white focus:ring-green-500" disabled>
                <i class="fas fa-play fa-2x"></i>
            </button>

            <button id="stop-btn" class="circle-button transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-wait
                                         bg-red-500 hover:bg-red-600 text-white focus:ring-red-500" disabled>
                <i class="fas fa-stop fa-2x"></i>
            </button>
        </div>

        <div id="message-box" class="mt-4 text-sm text-gray-500 dark:text-gray-400 min-h-[1.5rem]"></div>

    </div>

    <script>

        // Get references to DOM elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusLabel = document.getElementById('status-label');
        const messageBox = document.getElementById('message-box');
        const statusContainer = document.getElementById('status-container'); // Ensure this ID exists in your HTML

        // State variable to track the system's status
        let isSystemRunning = false;

        // The API Helper Function
        async function apiCall(endpoint, method = 'POST') {
            const url = `${window.location.origin}${endpoint}`;
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        // Pass initData so the server can verify the user is who they say they are
                        'X-Telegram-Init-Data': window.Telegram.WebApp.initData 
                    }
                });
                if (!response.ok) throw new Error('Server error');
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showMessage('Error: Could not reach the server.');
                return null;
            }
        }

        /**
         * Updates the UI based on the system's current confirmed status.
         * This function handles the core requirement of enabling/disabling buttons.
         */
        function updateUI() {
            // Tailwind classes for visual feedback
            const runningClasses = ['bg-green-600', 'text-white', 'shadow-lg', 'shadow-green-500/50'];
            const stoppedClasses = ['bg-black', 'text-white', 'shadow-lg', 'shadow-gray-700/50'];
            if (isSystemRunning) {
                // System is running: disable start, enable stop
                statusLabel.textContent = 'System is RUNNING.';
                startBtn.disabled = true;  // Start disabled when running
                stopBtn.disabled = false;
                // Visual update
                statusContainer.classList.remove(...stoppedClasses);
                statusContainer.classList.add(...runningClasses);
            } else {
                // System is stopped: enable start, disable stop
                statusLabel.textContent = 'System is STOPPED.';
                startBtn.disabled = false;
                stopBtn.disabled = true;   // Stop disabled when stopped
                // Visual update
                statusContainer.classList.remove(...runningClasses);
                statusContainer.classList.add(...stoppedClasses);
            }
        }
        
        /**
         * Temporarily disables or enables action buttons. Used while waiting for bot response.
         * @param {boolean} disabled True to disable buttons, false to enable.
         */
        function setButtonsDisabled(disabled) {
            // Disable both buttons to prevent race conditions while waiting for bot response
            startBtn.disabled = disabled;
            stopBtn.disabled = disabled;
        }

        /**
         * Displays a message to the user in the message box.
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            messageBox.textContent = message;
            // Clear message after 3 seconds
            setTimeout(() => {
                if (messageBox.textContent === message) {
                    messageBox.textContent = '';
                }
            }, 3000); 
        }

        // --- Telegram Web App SDK Logic ---
        if (window.Telegram && window.Telegram.WebApp) {
            // 1. Core setup
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            // Initial status check from the server API
            async function initStatus() {
                setButtonsDisabled(true);
                showMessage('Syncing with server...');
                const result = await apiCall('/api/status', 'GET');
                if (result) {
                    isSystemRunning = (result.status === 'running');
                    updateUI();
                    showMessage('System ready.');
                }
                setButtonsDisabled(false);
            }
            initStatus();
        } else {
            // Fallback for testing outside Telegram
            showMessage('Telegram WebApp is NOT available. Using local simulation mode.');
            updateUI(); // Run UI update for local simulation
        }

        // --- Event Listeners for UI Buttons ---

        // Event listener for the "Start" button
        startBtn.addEventListener('click', async () => {
            setButtonsDisabled(true);
            showMessage('Starting system...');
            
            const result = await apiCall('/api/up');
            if (result && result.status === 'running') {
                isSystemRunning = true;
                showMessage('System is now running.');
            }
            updateUI();
        });

        // Event listener for the "Stop" button
        stopBtn.addEventListener('click', async () => {
            setButtonsDisabled(true);
            showMessage('Stopping system...');
            
            const result = await apiCall('/api/down');
            if (result && result.status === 'stopped') {
                isSystemRunning = false;
                showMessage('System is now stopped.');
            }
            updateUI();
        });
    </script>

</body>
</html>